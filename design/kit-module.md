# Design: shinymap.kit Module

**Status**: Design Phase
**Related**: `packages/shinymap/python/src/shinymap/outline/converter/` (to be migrated)

## Overview

The `kit` module provides a suite of interactive tools for preparing SVG files for use with shinymap.

**Simplified approach**: Most of `_conversion.py` is redundant now that `Outline` has rich functionality. The kit module will:
1. Add two new fluent methods to `Outline`: `move_layer()` and `move_group()`
2. Provide a simple `apply_mapping()` function for one-shot conversion from mapping dict
3. Move only the interactive apps and code generation to `kit`

## Workflow

```
Input: SVG file
    ↓ Outline.from_svg()
Intermediate JSON (auto-generated IDs: path_1, circle_2, etc.)
    ↓ [kit.caption] Generate reference SVG with ID labels
    ↓ Relabeling/Regrouping/Layer assignment (using sketch app or manual mapping)
Output: Final JSON (meaningful IDs, layer config, ready for Shiny app)
```

## Module Structure

```
shinymap/
├── kit/
│   ├── __init__.py          # Public API exports (apply_mapping, describe, glaze, generate_code)
│   ├── _app_sketch.py       # Sketch Shiny app (migrated from outline/converter/_app.py)
│   ├── _app_review.py       # Review Shiny app (new)
│   ├── _caption.py          # describe(), glaze() functions
│   ├── _code_gen.py         # generate_code(), apply_mapping()
│   ├── sketch/              # Runnable module: python -m shinymap.kit.sketch
│   │   └── __main__.py
│   ├── review/              # Runnable module: python -m shinymap.kit.review
│   │   └── __main__.py
│   └── caption/             # Runnable module: python -m shinymap.kit.caption
│       └── __main__.py
└── outline/
    ├── _outline.py          # Add: move_layer(), move_group() methods
    ├── _conversion.py       # Deprecate (functionality moved to Outline methods)
    └── converter/           # EOL stub: raises ImportError with migration message
```

### Command Interface

```bash
# Generate reference SVG with ID labels overlaid
uv run python -m shinymap.kit.caption input.svg -o labeled.svg

# Interactive sketch app (relabeling, regrouping, layer assignment)
uv run python -m shinymap.kit.sketch [-f FILE]

# Interactive review app (view outline, check aesthetics)
uv run python -m shinymap.kit.review [-f FILE]
```

## New Outline Methods

These methods will be added to the `Outline` class for fluent step-by-step conversion.

### move_layer(layer, *region_ids)

Move regions to a specific layer (underlay, overlay, hidden).

```python
outline = (
    Outline.from_svg("map.svg")
    .move_layer("underlay", "_grid", "_background")
    .move_layer("overlay", "_border", "_dividers")
    .move_layer("hidden", "_construction_guides")
)
```

**Signature**:
```python
def move_layer(self, layer: Literal["underlay", "overlay", "hidden"], *region_ids: str) -> Outline:
    """Move regions to the specified layer.

    Args:
        layer: Target layer ("underlay", "overlay", or "hidden")
        *region_ids: Region IDs to move

    Returns:
        New Outline with updated layer assignments
    """
```

### move_group(group_id, *region_ids)

Rename a region or merge multiple regions into a new group.

```python
outline = (
    Outline.from_svg("map.svg")
    .move_group("hokkaido", "path_1", "path_2", "path_3")  # Merge 3 paths
    .move_group("tokyo", "path_4")                          # Rename single path
    .move_group("osaka", "path_5")
)
```

**Signature**:
```python
def move_group(self, group_id: str, *region_ids: str) -> Outline:
    """Rename a region or merge multiple regions into a group.

    Args:
        group_id: New ID for the group
        *region_ids: Region IDs to include in the group

    Returns:
        New Outline with the group applied

    Note:
        This is a fluent alternative to relabel(). Equivalent to:
        outline.relabel({group_id: list(region_ids)})
    """
```

### One-shot Conversion

For batch conversion from a mapping file (generated by converter app):

```python
from shinymap.kit import apply_mapping

# mapping dict structure (generated by converter app code generation)
mapping = {
    "groups": {
        "hokkaido": ["path_1", "path_2"],
        "tokyo": "path_4",
    },
    "layers": {
        "overlays": ["_border"],
        "hidden": ["_guides"],
    },
    "lines_as_path": ["_divider"],
    "metadata": {"source": "...", "license": "..."},
}

outline = apply_mapping(Outline.from_svg("map.svg"), mapping)
```

## Kit Tools

### 1. Caption Tool (New)

Generate a reference SVG with auto-generated IDs displayed at region centers. Essential for planning relabeling mappings.

**Command**:
```bash
uv run python -m shinymap.kit.caption map.svg -o map_labeled.svg
```

**Composable functions**:

#### `kit.describe(outline, exclude=None) -> Regions`

Generate Text elements showing region IDs at each region's center.

```python
def describe(outline: Outline, exclude: list[str] | None = None) -> Regions:
    """Generate Text elements with region IDs at each region's center.

    Args:
        outline: Source outline
        exclude: Region IDs to skip (e.g., overlays, hidden)

    Returns:
        Regions dict with Text elements keyed as "_label_{region_id}"
    """
    labels = {}
    for region_id in outline.region_ids():
        if exclude and region_id in exclude:
            continue
        bounds = outline.bounds(region_id)
        center_x = (bounds[0] + bounds[2]) / 2
        center_y = (bounds[1] + bounds[3]) / 2
        labels[f"_label_{region_id}"] = [Text(
            x=center_x, y=center_y,
            text=region_id,
            text_anchor="middle",
            dominant_baseline="central",
            font_size="3",
            fill="#333",
        )]
    return Regions(labels)
```

#### `kit.glaze(outline, regions, as_overlay=True) -> Outline`

Add regions as an overlay or underlay layer to an existing outline.

```python
def glaze(
    outline: Outline,
    regions: Regions | Outline,
    as_overlay: bool = True,
) -> Outline:
    """Add regions as overlay/underlay to an outline.

    Args:
        outline: Base outline
        regions: Regions to add (Regions dict or Outline)
        as_overlay: If True, add as overlay; if False, add as underlay

    Returns:
        New Outline with regions merged and layer assigned
    """
    if isinstance(regions, Outline):
        to_merge = regions
    else:
        to_merge = Outline.from_dict(regions)

    layer_key = "overlays" if as_overlay else "underlays"
    return outline.merge(to_merge).merge_layers({
        layer_key: list(to_merge.region_ids())
    })
```

**Usage - ID labeling**:
```python
from shinymap import Outline, export_svg
from shinymap.kit import describe, glaze

outline = Outline.from_svg("map.svg")
labels = describe(outline, exclude=outline.overlays())
labeled = glaze(outline, labels, as_overlay=True)
export_svg(labeled, "map_labeled.svg")
```

**Usage - Adding annotations**:
```python
from shinymap import Outline, Regions
from shinymap.svg import Text, Path
from shinymap.kit import glaze

annotations = Regions({
    "note_1": [Text(x=50, y=50, text="Important!")],
    "arrow_1": [Path(d="M 10 10 L 50 50")],
})
annotated = glaze(outline, annotations, as_overlay=True)
```

### 2. Relabeling Region IDs

**Current state**: ✅ Working in converter app

Transform auto-generated IDs to meaningful names:
```python
# Auto-generated → Meaningful
{
    "path_1": "M 0 0 L 10 0...",
    "path_2": "M 20 0 L 30 0...",
}
# ↓ Relabel
{
    "hokkaido": "M 0 0 L 10 0...",
    "aomori": "M 20 0 L 30 0...",
}
```

**UI workflow**:
1. Click region(s) on map
2. Enter new ID in text field
3. Click "Register" to apply relabeling
4. Repeat for all regions

### 3. Regrouping Regions (Merging)

**Current state**: ✅ Working in converter app

Merge multiple SVG elements into a single logical region:
```python
relabel = {
    "hokkaido": ["path_1", "path_2", "path_3"],  # Island archipelago
    "tokyo": "path_4",  # Single path
}
```

### 4. Layer Assignment

**Current state**: ⚠️ Partial (overlay only via radio buttons)

**Target state**: Full layer support with improved UI

| Layer | Purpose | Pointer Events |
|-------|---------|----------------|
| `hidden` | Construction guides, not rendered | N/A |
| `underlay` | Background grids, reference lines | `none` |
| `main` | Interactive regions | Active (default) |
| `overlay` | Borders, dividers, annotations | `none` |

**UI improvements needed**:
- Dropdown or segmented control: Hidden / Underlay / Main / Overlay
- Visual indicators for layer assignment (icons or colors in region list)
- Bulk layer assignment for selected regions

**Data structure**:
```json
{
  "_metadata": {
    "overlays": ["_border", "_dividers"],
    "underlays": ["_grid", "_background"],
    "hidden": ["_construction_guides"]
  }
}
```

### 5. Treat Path as Line

**Current state**: ⚠️ `path_as_line()` method exists, no UI

Mark path elements that should use line aesthetics (stroke only, no fill):

```python
# Method stores region IDs in metadata["lines_as_path"]
outline = outline.path_as_line("_divider", "_border")
```

**Detection heuristics** (for suggesting candidates):
```python
def is_stroke_only_candidate(elem) -> bool:
    """Suggest paths that might be lines."""
    fill = getattr(elem, "fill", "").lower() if hasattr(elem, "fill") else ""
    return (
        fill == "none" or
        fill == "transparent" or
        isinstance(elem, Line)  # SVG line elements
    )
```

**UI workflow**:
- Show "line" indicator for elements detected as stroke-only
- Toggle button: "Treat as Line" to add/remove from `lines_as_path`

### 6. Inspector App (New)

A lightweight app for viewing and validating outline files without editing.

**Use cases**:
- Preview JSON outline before using in Shiny app
- Verify layer assignments are correct
- Check aesthetic resolution with StillLife
- Debug region ID issues

**Features**:
- Load JSON or SVG file
- Display map with layer visualization (color-coded by layer)
- Click region to see: ID, element type, layer, bounds
- "Test with aesthetics" panel: apply sample wash and see results
- Export as static SVG (using `StillLife.to_svg()`)

## Migration Plan

### Phase 1: Add new Outline methods
1. Add `move_layer()` method to `Outline` class
2. Add `move_group()` method to `Outline` class
3. Add tests for new methods
4. Update CLAUDE.md with new method documentation

### Phase 2: Create kit module structure
1. Create `shinymap/kit/` directory with `__init__.py`
2. Move `converter/_app.py` → `kit/_app_sketch.py`
3. Move code generation from `converter/_tool.py` → `kit/_code_gen.py`
4. Create `kit/_caption.py` with `describe()` and `glaze()`
5. Create `kit/sketch/__main__.py` with argparse
6. Add `apply_mapping()` function to `kit/_code_gen.py`
7. Update sketch app to use new Outline methods
8. Update code generation to emit fluent method calls

### Phase 3: Clean up old locations
1. Remove `from_svg`, `from_json`, `convert`, `infer_relabel` from `outline/__init__.py` exports
2. Deprecate `outline/_conversion.py` (keep `infer_relabel()` if still useful for code generation)
3. Add EOL stub for `outline/converter/`:
```python
# shinymap/outline/converter/__init__.py (EOL stub)
"""This module has moved to shinymap.kit.sketch."""

def __getattr__(name: str):
    raise ImportError(
        "'shinymap.outline.converter' has moved to 'shinymap.kit.sketch'. "
        "Run with: uv run python -m shinymap.kit.sketch"
    )
```

### Phase 4: Create caption tool
1. Create `kit/caption/__main__.py` CLI
2. Add tests for describe() and glaze()

### Phase 5: Enhance sketch app
1. Add full layer support (underlay, hidden in addition to overlay)
2. Add "Treat as Line" toggle
3. Improve multi-select UX
4. Add undo/redo for operations

### Phase 6: Create review app
1. Create `kit/_app_review.py`
2. Create `kit/review/__main__.py`
3. Add StillLife integration for aesthetic preview

## API Exports

```python
# shinymap/kit/__init__.py
from shinymap.kit._code_gen import apply_mapping, generate_code
from shinymap.kit._caption import describe, glaze

__all__ = [
    # Conversion
    "apply_mapping",
    "generate_code",
    # Composable utilities
    "describe",
    "glaze",
]
```

The main apps are run as modules, not imported:
```bash
uv run python -m shinymap.kit.caption   # Generate labeled SVG
uv run python -m shinymap.kit.sketch    # Interactive relabeling app
uv run python -m shinymap.kit.review    # View/validate outline
```

## Implementation Checklist

### Phase 1: Add Outline Methods
- [ ] Add `move_layer()` method to `Outline` class
- [ ] Add `move_group()` method to `Outline` class
- [ ] Add tests for new methods
- [ ] Update CLAUDE.md with new method documentation

### Phase 2: Create Kit Module
- [ ] Create `kit/` directory with `__init__.py`
- [ ] Create `kit/_app_sketch.py` (migrate from outline/converter)
- [ ] Create `kit/_code_gen.py` (apply_mapping, generate_code)
- [ ] Create `kit/_caption.py` (describe, glaze)
- [ ] Create `kit/sketch/__main__.py`
- [ ] Update all internal imports
- [ ] Add EOL stub at old converter location
- [ ] Update CLAUDE.md quick reference links
- [ ] Add tests for module imports

### Phase 3: Caption Tool
- [ ] Create `kit/caption/__main__.py` CLI
- [ ] Add font-size and color CLI options
- [ ] Add tests for describe() and glaze()

### Phase 4: Layer Enhancement
- [ ] Add layer dropdown to sketch UI (hidden/underlay/main/overlay)
- [ ] Update `relabel_rules` to track layer per region
- [ ] Add visual layer indicators in region list
- [ ] Implement bulk layer assignment for selections
- [ ] Update code generation to include all layer types

### Phase 5: Treat as Line
- [ ] Add `is_stroke_only_candidate()` detection
- [ ] Add "Treat as Line" indicator in sketch UI
- [ ] Add toggle to add/remove from `lines_as_path`
- [ ] Update code generation to include `path_as_line()` calls

### Phase 6: Review App
- [ ] Create `kit/_app_review.py`
- [ ] Create `kit/review/__main__.py`
- [ ] Implement layer visualization (color-coded regions)
- [ ] Implement click-to-inspect region details
- [ ] Add StillLife aesthetic preview panel
- [ ] Add static SVG export button

## Open Questions

1. **Should caption be CLI-only or also have a Shiny app?**
   - CLI is simpler and fits the workflow (generate once, reference while working)
   - Shiny app would allow interactive font/color adjustment
   - **Decision**: Start with CLI, add interactive mode later if needed

2. **Should review be a separate app or a tab in sketch?**
   - Separate app: Cleaner separation of concerns, lighter weight
   - Tab in sketch: Single entry point, easier discovery
   - **Decision**: Separate app for now, can reconsider later

3. **How to handle overlapping labels in caption?**
   - Small regions may have overlapping text
   - Options: smaller font, leader lines, skip small regions
   - **Decision**: Start simple, address if it becomes a problem

4. **How should describe() calculate font size?**
   - Fixed size (current): Simple but may be too large/small
   - Auto-scale based on region bounds: More complex but better fit
   - CLI option: Let user specify
   - **Decision**: TBD

5. **Should glaze() prefix label IDs automatically?**
   - Current design: `_label_{region_id}` prefix
   - Risk: User's regions might already use `_label_` prefix
   - Alternative: Configurable prefix or no prefix (user provides full IDs)
   - **Decision**: TBD

6. **What if region has complex shape where bounding box center is outside the region?**
   - Example: C-shaped or ring-shaped regions
   - Options: Use centroid calculation, visual centroid, or just accept imperfect placement
   - **Decision**: Start with bounding box center, improve if real-world issues arise

## Testing Strategy

1. **Unit tests**: `describe()`, `glaze()`, bounds calculations
2. **Integration tests**: End-to-end SVG → labeled SVG → JSON conversion
3. **Snapshot tests**: Generated code matches expected output
4. **Manual testing**: Interactive apps with sample SVG files

## Related Documents

- [SPEC.md](../SPEC.md) - Overall project specification
- [aes-resolution.md](aes-resolution.md) - Aesthetic resolution architecture
- [CONTRIBUTING.md](../CONTRIBUTING.md) - Development workflow

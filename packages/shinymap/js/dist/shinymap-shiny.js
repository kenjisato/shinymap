"use strict";(()=>{function A(e){return e.replace(/_([a-z])/g,(p,s)=>s.toUpperCase())}var V=new Set(["regions","tooltips","value","fill_color","fillColor","stroke_color","strokeColor","stroke_width","strokeWidth","fill_opacity","fillOpacity"]);function H(e){return e.startsWith("_")}function D(e){return V.has(e)}function N(e){if(e==null)return e;if(Array.isArray(e))return e.map(s=>c(s));if(typeof e!="object")return e;let p={};for(let[s,r]of Object.entries(e))p[s]=c(r);return p}function c(e){if(e==null)return e;if(Array.isArray(e))return e.map(s=>c(s));if(typeof e!="object")return e;let p={};for(let[s,r]of Object.entries(e)){let S=H(s)?s:A(s);D(s)?p[S]=N(r):p[S]=c(r)}return p}var $=50,K=5e3;function P(e=performance.now()){let p=typeof globalThis<"u"&&globalThis.shinymap||typeof window<"u"&&window.shinymap||(typeof shinymap<"u"?shinymap:null);if(!p||typeof p.renderInputMap!="function"||typeof p.renderOutputMap!="function"){performance.now()-e<K?setTimeout(()=>P(e),$):console.warn("[shinymap] Global bundle not found after waiting; maps will not render.");return}let s=!!window.localStorage?.getItem("shinymapDebug"),r=(...n)=>{s&&console.log(...n)},{renderInputMap:S,renderOutputMap:O}=p;function w(n,a){let o=a,i=a.replace(/([A-Z])/g,"_$1").toLowerCase(),t=a.replace(/[A-Z]/g,g=>`-${g.toLowerCase()}`),m=n.dataset[o]??n.dataset[i]??n.getAttribute(`data-${t}`)??n.getAttribute(`data_${i}`);if(!m)return null;try{return JSON.parse(m)}catch(g){return console.warn("[shinymap] Failed to parse data attribute",a,g),null}}function k(n){if(r("[shinymap] mountInput",n),n.dataset.shinymapMounted==="input")return;let a=w(n,"shinymapProps")||w(n,"shinymap_props")||{},o=c(a),i=n.dataset.shinymapInputId||n.dataset.shinymap_input_id||n.id,m=(o.mode||{}).type||n.dataset.shinymapInputMode||n.dataset.shinymap_input_mode||"multiple",g=o.raw===!0,M=l=>{if(g||m==="count"||m==="cycle")return l;let u=Object.entries(l).filter(([,f])=>f>0).map(([f])=>f);return m==="single"?u.length>0?u[0]:null:u};S(n,o,l=>{if(window.Shiny&&typeof window.Shiny.setInputValue=="function"&&i){let u=M(l);window.Shiny.setInputValue(i,u,{priority:"event"})}});let y=o.value??{},h=M(y);if(i){let l=0,u=50,f=()=>(l++,window.Shiny&&typeof window.Shiny.setInputValue=="function"?(window.Shiny.setInputValue(i,h),r("[shinymap] Set initial value for",i,h,`(attempt ${l})`),!0):(l<u?setTimeout(f,50):console.warn("[shinymap] Failed to set initial value for",i,"after",u,"attempts"),!1));f()}n.dataset.shinymapMounted="input"}function T(n){r("[shinymap] mountOutput",n);let a=w(n,"shinymapPayload")||w(n,"shinymap_payload")||{},o=c(a),i=n.dataset.shinymapClickInputId||n.dataset.shinymap_click_input_id,t=i&&window.Shiny&&typeof window.Shiny.setInputValue=="function"?m=>window.Shiny.setInputValue(i,m,{priority:"event"}):void 0;O(n,{...o,onRegionClick:t}),n.dataset.shinymapMounted="output"}function d(n=document){let a="[data-shinymap-input],[data_shinymap_input],.shinymap-input",o="[data-shinymap-output],[data_shinymap_output],.shinymap-output",i=Array.from(n.querySelectorAll(a)),t=Array.from(n.querySelectorAll(o));n!==document&&n instanceof HTMLElement&&(n.matches(a)&&i.push(n),n.matches(o)&&t.push(n)),r("[shinymap] scan found",i.length,"inputs",t.length,"outputs"),i.forEach(k),t.forEach(T)}new MutationObserver(n=>{for(let a of n)a.addedNodes.forEach(o=>{o instanceof HTMLElement&&d(o)}),a.type==="attributes"&&a.target instanceof HTMLElement&&(a.attributeName==="data-shinymap-payload"||a.attributeName==="data_shinymap_payload")&&(r("[shinymap] Payload attribute changed on",a.target),T(a.target))}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-shinymap-payload","data_shinymap_payload"]});let R=n=>{n&&n instanceof HTMLElement?d(n):d()};document.addEventListener("shiny:outputupdated",n=>{r("[shinymap] shiny:outputupdated event for",n.target?.id),setTimeout(()=>R(n.target),10)}),document.addEventListener("shiny:idle",()=>{r("[shinymap] shiny:idle event"),R()}),document.addEventListener("shiny:connected",()=>{r("[shinymap] shiny:connected event"),R()});let b=()=>d();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b):b(),setTimeout(()=>d(),25),setTimeout(()=>d(),150),setTimeout(()=>d(),300),setTimeout(()=>d(),500),setTimeout(()=>d(),1e3),setTimeout(()=>d(),2e3),window.shinymapScan=d,window.Shiny&&window.Shiny.addCustomMessageHandler("shinymap-update",n=>{try{let{id:a,updates:o}=n,i=c(o),t=document.getElementById(a);if(!t){console.warn(`[shinymap] update_map: element with id="${a}" not found`);return}let m=t.classList.contains("shinymap-input")||t.dataset.shinymapInput,g=t.classList.contains("shinymap-output")||t.dataset.shinymapOutput;if(m){let M=w(t,"shinymapProps")||{},v=c(M),y={...v,...i};if(i.value===void 0){let h=v.value;h&&Object.keys(h).length>0?y.value=h:delete y.value}if(t.dataset.shinymapProps=JSON.stringify(y),t.__shinymapRoot&&window.shinymap?.renderInputMap){let h=t.dataset.shinymapInputId||t.dataset.shinymap_input_id||t.id,u=(y.mode||{}).type||t.dataset.shinymapInputMode||t.dataset.shinymap_input_mode||"multiple",f=y.raw===!0,C=I=>{if(f||u==="count"||u==="cycle")return I;let _=Object.entries(I).filter(([,E])=>E>0).map(([E])=>E);return u==="single"?_.length>0?_[0]:null:_},L=I=>{if(window.Shiny&&typeof window.Shiny.setInputValue=="function"&&h){let _=C(I);window.Shiny.setInputValue(h,_,{priority:"event"})}};window.shinymap.renderInputMap(t,y,L)}else t.__shinymapRoot&&(t.__shinymapRoot.unmount(),delete t.__shinymapRoot),delete t.dataset.shinymapMounted,k(t)}else if(g){let M=w(t,"shinymapPayload")||{},y={...c(M),...i};t.dataset.shinymapPayload=JSON.stringify(y),t.__shinymapRoot&&(t.__shinymapRoot.unmount(),delete t.__shinymapRoot),delete t.dataset.shinymapMounted,T(t)}else console.warn(`[shinymap] update_map: element id="${a}" is neither input nor output map`)}catch(a){console.error("[shinymap] update_map error:",a)}})}P();})();

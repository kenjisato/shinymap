"use strict";(()=>{function L(a){return a.replace(/_([a-z])/g,(r,u)=>u.toUpperCase())}var A=new Set(["geometry","tooltips","value","fill_color","fillColor","stroke_color","strokeColor","stroke_width","strokeWidth","fill_opacity","fillOpacity"]);function V(a){return A.has(a)}function H(a){if(a==null)return a;if(Array.isArray(a))return a.map(u=>l(u));if(typeof a!="object")return a;let r={};for(let[u,p]of Object.entries(a))r[u]=l(p);return r}function l(a){if(a==null)return a;if(Array.isArray(a))return a.map(u=>l(u));if(typeof a!="object")return a;let r={};for(let[u,p]of Object.entries(a)){let I=L(u);V(u)?r[I]=H(p):r[I]=l(p)}return r}var D=50,N=5e3;function b(a=performance.now()){let r=typeof globalThis<"u"&&globalThis.shinymap||typeof window<"u"&&window.shinymap||(typeof shinymap<"u"?shinymap:null);if(!r||typeof r.renderInputMap!="function"||typeof r.renderOutputMap!="function"){performance.now()-a<N?setTimeout(()=>b(a),D):console.warn("[shinymap] Global bundle not found after waiting; maps will not render.");return}let u=!!window.localStorage?.getItem("shinymapDebug"),p=(...n)=>{u&&console.log(...n)},{renderInputMap:I,renderOutputMap:O}=r;function g(n,e){let o=e,i=e.replace(/([A-Z])/g,"_$1").toLowerCase(),t=e.replace(/[A-Z]/g,f=>`-${f.toLowerCase()}`),m=n.dataset[o]??n.dataset[i]??n.getAttribute(`data-${t}`)??n.getAttribute(`data_${i}`);if(!m)return null;try{return JSON.parse(m)}catch(f){return console.warn("[shinymap] Failed to parse data attribute",e,f),null}}function E(n){if(p("[shinymap] mountInput",n),n.dataset.shinymapMounted==="input")return;let e=g(n,"shinymapProps")||g(n,"shinymap_props")||{},o=l(e),i=n.dataset.shinymapInputId||n.dataset.shinymap_input_id||n.id,m=(o.mode||{}).type||n.dataset.shinymapInputMode||n.dataset.shinymap_input_mode||"multiple",f=s=>{if(m==="count"||m==="cycle")return s;let h=Object.entries(s).filter(([,c])=>c>0).map(([c])=>c);return m==="single"?h.length>0?h[0]:null:h};I(n,o,s=>{if(window.Shiny&&typeof window.Shiny.setInputValue=="function"&&i){let h=f(s);window.Shiny.setInputValue(i,h,{priority:"event"})}});let w=o.value??{},y=f(w);if(i){let s=0,h=50,c=()=>(s++,window.Shiny&&typeof window.Shiny.setInputValue=="function"?(window.Shiny.setInputValue(i,y),p("[shinymap] Set initial value for",i,y,`(attempt ${s})`),!0):(s<h?setTimeout(c,50):console.warn("[shinymap] Failed to set initial value for",i,"after",h,"attempts"),!1));c()}n.dataset.shinymapMounted="input"}function T(n){p("[shinymap] mountOutput",n);let e=g(n,"shinymapPayload")||g(n,"shinymap_payload")||{},o=l(e),i=n.dataset.shinymapClickInputId||n.dataset.shinymap_click_input_id,t=i&&window.Shiny&&typeof window.Shiny.setInputValue=="function"?m=>window.Shiny.setInputValue(i,m,{priority:"event"}):void 0;O(n,{...o,onRegionClick:t}),n.dataset.shinymapMounted="output"}function d(n=document){let e="[data-shinymap-input],[data_shinymap_input],.shinymap-input",o="[data-shinymap-output],[data_shinymap_output],.shinymap-output",i=Array.from(n.querySelectorAll(e)),t=Array.from(n.querySelectorAll(o));n!==document&&n instanceof HTMLElement&&(n.matches(e)&&i.push(n),n.matches(o)&&t.push(n)),p("[shinymap] scan found",i.length,"inputs",t.length,"outputs"),i.forEach(E),t.forEach(T)}new MutationObserver(n=>{for(let e of n)e.addedNodes.forEach(o=>{o instanceof HTMLElement&&d(o)}),e.type==="attributes"&&e.target instanceof HTMLElement&&(e.attributeName==="data-shinymap-payload"||e.attributeName==="data_shinymap_payload")&&(p("[shinymap] Payload attribute changed on",e.target),T(e.target))}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-shinymap-payload","data_shinymap_payload"]});let v=n=>{n&&n instanceof HTMLElement?d(n):d()};document.addEventListener("shiny:outputupdated",n=>{p("[shinymap] shiny:outputupdated event for",n.target?.id),setTimeout(()=>v(n.target),10)}),document.addEventListener("shiny:idle",()=>{p("[shinymap] shiny:idle event"),v()}),document.addEventListener("shiny:connected",()=>{p("[shinymap] shiny:connected event"),v()});let k=()=>d();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",k):k(),setTimeout(()=>d(),25),setTimeout(()=>d(),150),setTimeout(()=>d(),300),setTimeout(()=>d(),500),setTimeout(()=>d(),1e3),setTimeout(()=>d(),2e3),window.shinymapScan=d,window.Shiny&&window.Shiny.addCustomMessageHandler("shinymap-update",n=>{try{let{id:e,updates:o}=n,i=l(o),t=document.getElementById(e);if(!t){console.warn(`[shinymap] update_map: element with id="${e}" not found`);return}let m=t.classList.contains("shinymap-input")||t.dataset.shinymapInput,f=t.classList.contains("shinymap-output")||t.dataset.shinymapOutput;if(m){let _=g(t,"shinymapProps")||{},w=l(_),y={...w,...i};if(i.value===void 0){let s=w.value;s&&Object.keys(s).length>0?y.value=s:delete y.value}if(t.dataset.shinymapProps=JSON.stringify(y),t.__shinymapRoot&&window.shinymap?.renderInputMap){let s=t.dataset.shinymapInputId||t.dataset.shinymap_input_id||t.id,c=(y.mode||{}).type||t.dataset.shinymapInputMode||t.dataset.shinymap_input_mode||"multiple",P=S=>{if(c==="count"||c==="cycle")return S;let M=Object.entries(S).filter(([,R])=>R>0).map(([R])=>R);return c==="single"?M.length>0?M[0]:null:M},C=S=>{if(window.Shiny&&typeof window.Shiny.setInputValue=="function"&&s){let M=P(S);window.Shiny.setInputValue(s,M,{priority:"event"})}};window.shinymap.renderInputMap(t,y,C)}else t.__shinymapRoot&&(t.__shinymapRoot.unmount(),delete t.__shinymapRoot),delete t.dataset.shinymapMounted,E(t)}else if(f){let _=g(t,"shinymapPayload")||{},y={...l(_),...i};t.dataset.shinymapPayload=JSON.stringify(y),t.__shinymapRoot&&(t.__shinymapRoot.unmount(),delete t.__shinymapRoot),delete t.dataset.shinymapMounted,T(t)}else console.warn(`[shinymap] update_map: element id="${e}" is neither input nor output map`)}catch(e){console.error("[shinymap] update_map error:",e)}})}b();})();

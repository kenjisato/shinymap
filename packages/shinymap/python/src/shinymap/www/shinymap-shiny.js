"use strict";(()=>{function L(e){return e.replace(/_([a-z])/g,(u,r)=>r.toUpperCase())}var A=new Set(["geometry","tooltips","value","fill_color","fillColor","stroke_color","strokeColor","stroke_width","strokeWidth","fill_opacity","fillOpacity"]);function V(e){return e.startsWith("_")}function H(e){return A.has(e)}function D(e){if(e==null)return e;if(Array.isArray(e))return e.map(r=>l(r));if(typeof e!="object")return e;let u={};for(let[r,p]of Object.entries(e))u[r]=l(p);return u}function l(e){if(e==null)return e;if(Array.isArray(e))return e.map(r=>l(r));if(typeof e!="object")return e;let u={};for(let[r,p]of Object.entries(e)){let I=V(r)?r:L(r);H(r)?u[I]=D(p):u[I]=l(p)}return u}var N=50,$=5e3;function b(e=performance.now()){let u=typeof globalThis<"u"&&globalThis.shinymap||typeof window<"u"&&window.shinymap||(typeof shinymap<"u"?shinymap:null);if(!u||typeof u.renderInputMap!="function"||typeof u.renderOutputMap!="function"){performance.now()-e<$?setTimeout(()=>b(e),N):console.warn("[shinymap] Global bundle not found after waiting; maps will not render.");return}let r=!!window.localStorage?.getItem("shinymapDebug"),p=(...n)=>{r&&console.log(...n)},{renderInputMap:I,renderOutputMap:P}=u;function g(n,a){let o=a,i=a.replace(/([A-Z])/g,"_$1").toLowerCase(),t=a.replace(/[A-Z]/g,f=>`-${f.toLowerCase()}`),m=n.dataset[o]??n.dataset[i]??n.getAttribute(`data-${t}`)??n.getAttribute(`data_${i}`);if(!m)return null;try{return JSON.parse(m)}catch(f){return console.warn("[shinymap] Failed to parse data attribute",a,f),null}}function E(n){if(p("[shinymap] mountInput",n),n.dataset.shinymapMounted==="input")return;let a=g(n,"shinymapProps")||g(n,"shinymap_props")||{},o=l(a),i=n.dataset.shinymapInputId||n.dataset.shinymap_input_id||n.id,m=(o.mode||{}).type||n.dataset.shinymapInputMode||n.dataset.shinymap_input_mode||"multiple",f=s=>{if(m==="count"||m==="cycle")return s;let h=Object.entries(s).filter(([,c])=>c>0).map(([c])=>c);return m==="single"?h.length>0?h[0]:null:h};I(n,o,s=>{if(window.Shiny&&typeof window.Shiny.setInputValue=="function"&&i){let h=f(s);window.Shiny.setInputValue(i,h,{priority:"event"})}});let w=o.value??{},y=f(w);if(i){let s=0,h=50,c=()=>(s++,window.Shiny&&typeof window.Shiny.setInputValue=="function"?(window.Shiny.setInputValue(i,y),p("[shinymap] Set initial value for",i,y,`(attempt ${s})`),!0):(s<h?setTimeout(c,50):console.warn("[shinymap] Failed to set initial value for",i,"after",h,"attempts"),!1));c()}n.dataset.shinymapMounted="input"}function v(n){p("[shinymap] mountOutput",n);let a=g(n,"shinymapPayload")||g(n,"shinymap_payload")||{},o=l(a),i=n.dataset.shinymapClickInputId||n.dataset.shinymap_click_input_id,t=i&&window.Shiny&&typeof window.Shiny.setInputValue=="function"?m=>window.Shiny.setInputValue(i,m,{priority:"event"}):void 0;P(n,{...o,onRegionClick:t}),n.dataset.shinymapMounted="output"}function d(n=document){let a="[data-shinymap-input],[data_shinymap_input],.shinymap-input",o="[data-shinymap-output],[data_shinymap_output],.shinymap-output",i=Array.from(n.querySelectorAll(a)),t=Array.from(n.querySelectorAll(o));n!==document&&n instanceof HTMLElement&&(n.matches(a)&&i.push(n),n.matches(o)&&t.push(n)),p("[shinymap] scan found",i.length,"inputs",t.length,"outputs"),i.forEach(E),t.forEach(v)}new MutationObserver(n=>{for(let a of n)a.addedNodes.forEach(o=>{o instanceof HTMLElement&&d(o)}),a.type==="attributes"&&a.target instanceof HTMLElement&&(a.attributeName==="data-shinymap-payload"||a.attributeName==="data_shinymap_payload")&&(p("[shinymap] Payload attribute changed on",a.target),v(a.target))}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-shinymap-payload","data_shinymap_payload"]});let T=n=>{n&&n instanceof HTMLElement?d(n):d()};document.addEventListener("shiny:outputupdated",n=>{p("[shinymap] shiny:outputupdated event for",n.target?.id),setTimeout(()=>T(n.target),10)}),document.addEventListener("shiny:idle",()=>{p("[shinymap] shiny:idle event"),T()}),document.addEventListener("shiny:connected",()=>{p("[shinymap] shiny:connected event"),T()});let k=()=>d();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",k):k(),setTimeout(()=>d(),25),setTimeout(()=>d(),150),setTimeout(()=>d(),300),setTimeout(()=>d(),500),setTimeout(()=>d(),1e3),setTimeout(()=>d(),2e3),window.shinymapScan=d,window.Shiny&&window.Shiny.addCustomMessageHandler("shinymap-update",n=>{try{let{id:a,updates:o}=n,i=l(o),t=document.getElementById(a);if(!t){console.warn(`[shinymap] update_map: element with id="${a}" not found`);return}let m=t.classList.contains("shinymap-input")||t.dataset.shinymapInput,f=t.classList.contains("shinymap-output")||t.dataset.shinymapOutput;if(m){let _=g(t,"shinymapProps")||{},w=l(_),y={...w,...i};if(i.value===void 0){let s=w.value;s&&Object.keys(s).length>0?y.value=s:delete y.value}if(t.dataset.shinymapProps=JSON.stringify(y),t.__shinymapRoot&&window.shinymap?.renderInputMap){let s=t.dataset.shinymapInputId||t.dataset.shinymap_input_id||t.id,c=(y.mode||{}).type||t.dataset.shinymapInputMode||t.dataset.shinymap_input_mode||"multiple",O=S=>{if(c==="count"||c==="cycle")return S;let M=Object.entries(S).filter(([,R])=>R>0).map(([R])=>R);return c==="single"?M.length>0?M[0]:null:M},C=S=>{if(window.Shiny&&typeof window.Shiny.setInputValue=="function"&&s){let M=O(S);window.Shiny.setInputValue(s,M,{priority:"event"})}};window.shinymap.renderInputMap(t,y,C)}else t.__shinymapRoot&&(t.__shinymapRoot.unmount(),delete t.__shinymapRoot),delete t.dataset.shinymapMounted,E(t)}else if(f){let _=g(t,"shinymapPayload")||{},y={...l(_),...i};t.dataset.shinymapPayload=JSON.stringify(y),t.__shinymapRoot&&(t.__shinymapRoot.unmount(),delete t.__shinymapRoot),delete t.dataset.shinymapMounted,v(t)}else console.warn(`[shinymap] update_map: element id="${a}" is neither input nor output map`)}catch(a){console.error("[shinymap] update_map error:",a)}})}b();})();
